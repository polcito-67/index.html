<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SMW Pixel Designer (Lunar Magic RIP)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body { margin:0; font-family:'Press Start 2P',monospace; image-rendering:pixelated; background:#6c88c4; }
    header { background:#3d5a99; color:white; text-align:center; padding:.8em; font-size:1.2em; border-bottom:4px solid #fff; }
    .container { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1em; padding:1em; }
    .panel { background:#a9bfe3; border:4px solid #4b6faa; padding:1em; border-radius:6px; box-shadow:2px 2px #2a446e; }
    button, select, input[type=file], input[type=range] { font-family:inherit; background:#d8e3f8; border:2px solid #3c5d91; color:#000; padding:.3em; width:100%; cursor:pointer; margin:.3em 0; }
    canvas { background:#000; border:3px solid #fff; margin-top:.5em; width:100%; height:auto; }
    label { font-size:.75em; }
    #previewParts { display:flex; flex-wrap:wrap; gap:.5em; margin-top:1em; }
    .part-preview { background:#fff; border:2px solid #333; padding:.2em; text-align:center; }
    .part-preview canvas { border:2px solid #000; width:64px; height:auto; }
  </style>
</head>
<body>
  <header>SMW Pixel Designer – Compatible con Lunar Magic</header>
  <div class="container">
    <div class="panel">
      <h3>Rip / Diseño de BG‑FG</h3>
      <input type="file" accept="image/*" onchange="handleImageUpload(event)">
      <label>Modo (tamaño canvas):</label>
      <select id="mode">
        <option value="fg_256">256×256</option>
        <option value="fg_512">512×256</option>
        <option value="fg_512s">512×512</option>
        <option value="bg_512">512×512</option>
        <option value="bg_1024">1024×512</option>
        <option value="bg_1024s">1024×1024</option>
      </select>
      <label>Cuantización (grises):</label>
      <input type="range" id="quant" min="1" max="64" value="16">
      <button onclick="fullSmartOptimization()">Optimizar color</button>
      <label>Escena IA:</label>
      <select id="aiPrompt">
        <option value="lava cave">Cueva de Lava</option>
        <option value="forest ruins">Ruinas Bosque</option>
        <option value="water temple">Templo Acuático</option>
        <option value="ice mountain">Montaña de Hielo</option>
        <option value="sky castle">Castillo en el Cielo</option>
      </select>
      <button onclick="generateWithAI()">Generar IA</button>
      <button id="exportBtn">Exportar ExGFX (PNG)</button>
      <div id="message"></div>
      <div id="previewParts"></div>
    </div>
    <div class="panel">
      <h3>Vista Previa</h3>
      <label>Original / Optimizada = misma vista</label>
      <canvas id="optimizedCanvas" width="256" height="256"></canvas>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('optimizedCanvas');
    const ctx = canvas.getContext('2d');
    const modeSizes = {
      fg_256:[256,256], fg_512:[512,256], fg_512s:[512,512],
      bg_512:[512,512], bg_1024:[1024,512], bg_1024s:[1024,1024]
    };
    const btnExport = document.getElementById('exportBtn');
    let secretMode=false;

    document.getElementById('mode').addEventListener('change', e=>{
      const [w,h]=modeSizes[e.target.value];
      canvas.width=w; canvas.height=h;
      ctx.clearRect(0,0,w,h); updatePreviewTiles();
      showMsg(`Modo: ${w}×${h}`);
    });

    function handleImageUpload(evt){
      const f=evt.target.files[0]; if(!f) return;
      const img=new Image();
      img.onload=()=>{
        canvas.width=img.width; canvas.height=img.height;
        ctx.drawImage(img,0,0);
        quantize(); showMsg('Imagen cargada');
        updatePreviewTiles();
      };
      img.src=URL.createObjectURL(f);
    }

    function fullSmartOptimization(){
      quantize();
      showMsg('Optimización aplicada');
      updatePreviewTiles();
    }

    function quantize(){
      const q=+document.getElementById('quant').value;
      const d=ctx.getImageData(0,0,canvas.width,canvas.height);
      for(let i=0;i<d.data.length;i+=4){
        let avg=(d.data[i]+d.data[i+1]+d.data[i+2])/3;
        let r= Math.floor(avg/(256/q))*(256/q);
        d.data[i]=d.data[i+1]=d.data[i+2]= r;
      }
      ctx.putImageData(d,0,0);
    }

    function generateWithAI(){
      const prompt=document.getElementById('aiPrompt').value;
      const colors={'lava cave':'#ff4400','forest ruins':'#228B22','water temple':'#0077be','ice mountain':'#b0e0e6','sky castle':'#d8bfd8'};
      const [w,h]=modeSizes[document.getElementById('mode').value];
      canvas.width=w; canvas.height=h;
      ctx.fillStyle=colors[prompt]||'#888'; ctx.fillRect(0,0,w,h);
      showMsg(`Escena IA: ${prompt}`);
      updatePreviewTiles();
    }

    function updatePreviewTiles(){
      const cont=document.getElementById('previewParts'); cont.innerHTML='';
      const s=16;
      for(let y=0;y<canvas.height;y+=s){
        for(let x=0;x<canvas.width;x+=s){
          const p=document.createElement('canvas');
          p.width=p.height=s;
          p.getContext('2d').putImageData(ctx.getImageData(x,y,s,s),0,0);
          const w=document.createElement('div');
          w.className='part-preview';
          w.appendChild(p);
          cont.appendChild(w);
        }
      }
    }

    btnExport.addEventListener('mousedown', e=>{ if(e.ctrlKey) secretMode=true; });
    btnExport.addEventListener('mouseup', ()=>{ setTimeout(()=>secretMode=false,200); });
    btnExport.addEventListener('click', e=>{
      const link=document.createElement('a');
      link.download = secretMode?'rip_smexgfx.png':'rip_exgfx.png';
      link.href=canvas.toDataURL('image/png');
      link.click();
      showMsg(secretMode?'Secret: PNG ExGFX (presente)':'PNG ExGFX descargado');
    });

    function showMsg(t){ document.getElementById('message').innerText=t; }
  </script>
</body>
</html>
